<!DOCTYPE html>
<html lang="vi" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Tài Xỉu - Quản Lý Tài Khoản</title>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css"/>

    <style>
        :root {
            --primary-color: #c0392b; --secondary-color: #f1c40f;
            --bg-color: #1e3a2a; --win-color: #27ae60; --loss-color: #e74c3c;
        }
        body {
            display: flex; justify-content: center; align-items: flex-start;
            min-height: 100vh; background-color: #111827; padding: 1rem;
        }
        .main-layout {
            display: grid; grid-template-columns: 2fr 1fr; gap: 1.5rem;
            width: 100%; max-width: 1400px;
        }
        article.card {
            background-color: var(--bg-color); border: 3px solid var(--border-color);
            padding: 1.5rem;
        }
        .card h2, #login-screen h1 { color: var(--secondary-color); text-align: center; }

        /* --- Màn hình đăng nhập / Quản lý tài khoản --- */
        #login-screen { max-width: 500px; margin: auto; }
        #existing-accounts-list {
            display: flex; flex-direction: column; gap: 0.75rem;
            margin-top: 1.5rem; max-height: 30vh; overflow-y: auto;
        }
        .account-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 0.75rem; border: 1px solid var(--pico-form-element-border-color);
            border-radius: var(--pico-border-radius); cursor: pointer;
            transition: background-color 0.2s;
        }
        .account-item:hover { background-color: var(--pico-color-primary-hover); }
        .account-item .delete-btn {
            background-color: var(--loss-color); color: white;
            padding: 0.2rem 0.5rem; font-size: 0.8em; border: none; cursor: pointer;
        }
        #create-account-form { margin-top: 2rem; border-top: 1px solid #444; padding-top: 1.5rem; }
        
        #game-container { display: none; }
        .player-info { display: flex; justify-content: space-between; align-items: center; }
        #logout-btn { margin-left: 1rem; }
        .dice { width: 70px; height: 70px; border-radius: 10px; display: flex; justify-content: center; align-items: center; font-size: 2.5rem; font-weight: bold; background-color: #fff; color: #333; }
        #dice-container { display: flex; justify-content: center; gap: 20px; margin: 1rem 0; }
        #result-text { font-weight: bold; min-height: 50px; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .bet-option { background-color: var(--primary-color); border: 2px solid var(--border-color); padding: 10px; cursor: pointer; text-align: center; font-weight: bold; }
        .bet-option.win { background-color: var(--win-color) !important; }
        .bet-option.lose { filter: brightness(0.5); }
        #history-table td.win { color: var(--win-color); font-weight: bold; }
        #history-table td.loss { color: var(--loss-color); font-weight: bold; }
        
        @media (max-width: 1024px) { .main-layout { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<main class="container" id="login-screen">
    <article class="card">
        <h1>Quản Lý Tài Khoản</h1>
        <div id="accounts-section">
            <h2>Chọn tài khoản hiện có</h2>
            <div id="existing-accounts-list">
                </div>
            <p id="no-accounts-msg" style="display: none; text-align: center;">Chưa có tài khoản nào. Hãy tạo một tài khoản mới!</p>
        </div>
        <form id="create-account-form">
            <h2>Tạo tài khoản mới</h2>
            <input type="text" id="username-input" placeholder="Nhập tên tài khoản mới" required>
            <button type="submit">Tạo và Chơi</button>
        </form>
         <button id="play-guest-btn" class="secondary" style="width: 100%; margin-top: 1rem;">Chơi với tư cách khách</button>
    </article>
</main>

<div id="game-container" class="main-layout">
    <article id="game-board" class="card">
        <h2>Bàn Cược</h2>
        <div class="player-info">
            <span id="player-name"></span>
            <button id="logout-btn" class="secondary outline" style="padding: 5px 10px;">Đăng Xuất</button>
            <span id="balance"></span>
        </div>
        <div class="grid">
            <div><label>Mức cược: <input type="number" id="bet-amount" value="50" min="1"></label></div>
            <div style="text-align:center;">
                <div id="dice-container">
                    <div class="dice" id="dice1">?</div><div class="dice" id="dice2">?</div><div class="dice" id="dice3">?</div>
                </div>
                <div id="result-text"><span id="result-message">Hãy đặt cược!</span><div id="countdown-timer"></div></div>
            </div>
        </div>
        <div class="betting-area" style="margin-top: 1.5rem;">
            <div class="grid"><button class="bet-option" data-bet-type="xiu">XỈU<div style="font-size:0.8rem; opacity:0.8;">4-10 (1:1)</div></button>
            <button class="bet-option" data-bet-type="tai">TÀI<div style="font-size:0.8rem; opacity:0.8;">11-17 (1:1)</div></button></div>
        </div>
        <div class="controls" style="margin-top: 1.5rem">
            <button id="roll-btn" style="background-color: var(--secondary-color); color: #000;">Lắc Xúc Xắc</button>
            <button id="reset-btn" class="secondary" disabled>Cược Lại</button>
        </div>
    </article>
    <article id="history-panel" class="card"><h2>Lịch Sử Cược</h2><div class="overflow-auto"><table id="history-table"><thead><tr><th>Ván</th><th>Xúc Xắc</th><th>Tổng</th><th>Kết Quả</th><th>+/- Điểm</th></tr></thead><tbody id="history-body"></tbody></table></div></article>
</div>


<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- Elements ---
    const loginScreen = document.getElementById('login-screen');
    const createAccountForm = document.getElementById('create-account-form');
    const usernameInput = document.getElementById('username-input');
    const existingAccountsList = document.getElementById('existing-accounts-list');
    const noAccountsMsg = document.getElementById('no-accounts-msg');
    const playGuestBtn = document.getElementById('play-guest-btn');
    const gameContainer = document.getElementById('game-container');
    const playerNameElem = document.getElementById('player-name');
    const logoutBtn = document.getElementById('logout-btn');
    const balanceElem = document.getElementById('balance');
    const betAmountInput = document.getElementById('bet-amount');
    const diceElems = [document.getElementById('dice1'), document.getElementById('dice2'), document.getElementById('dice3')];
    const resultMessageElem = document.getElementById('result-message');
    const countdownTimerElem = document.getElementById('countdown-timer');
    const betOptions = document.querySelectorAll('.bet-option');
    const rollBtn = document.getElementById('roll-btn');
    const resetBtn = document.getElementById('reset-btn');
    const historyBody = document.getElementById('history-body');

    // --- Game State ---
    let accounts = [];
    let currentPlayer = null;
    let playerBalance = 1000;
    let bets = {};
    let isRoundActive = false;
    let countdownIntervalId = null;
    let gameHistory = [];
    let roundCounter = 0;
    const PAYOUTS = { tai: 1, xiu: 1 };

    // --- ACCOUNT MANAGEMENT FUNCTIONS ---
    const getAccounts = () => JSON.parse(localStorage.getItem('sicbo_accounts')) || [];
    const saveAccounts = (updatedAccounts) => localStorage.setItem('sicbo_accounts', JSON.stringify(updatedAccounts));

    const displayAccounts = () => {
        accounts = getAccounts();
        existingAccountsList.innerHTML = '';
        if (accounts.length === 0) {
            noAccountsMsg.style.display = 'block';
        } else {
            noAccountsMsg.style.display = 'none';
            accounts.forEach(acc => {
                const item = document.createElement('div');
                item.className = 'account-item';
                item.innerHTML = `
                    <span><strong>${acc.name}</strong> - Điểm: ${acc.balance}</span>
                    <button class="delete-btn" data-name="${acc.name}">&times;</button>
                `;
                item.querySelector('span').addEventListener('click', () => login(acc.name));
                item.querySelector('.delete-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteAccount(acc.name);
                });
                existingAccountsList.appendChild(item);
            });
        }
    };
    
    const createAccount = (name) => {
        if (!name) return;
        accounts = getAccounts();
        if (accounts.some(acc => acc.name.toLowerCase() === name.toLowerCase())) {
            alert('Tên tài khoản này đã tồn tại!');
            return;
        }
        const newAccount = { name: name, balance: 1000, history: [] };
        accounts.push(newAccount);
        saveAccounts(accounts);
        login(name);
    };

    const deleteAccount = (name) => {
        if (confirm(`Bạn có chắc muốn xóa vĩnh viễn tài khoản "${name}"?`)) {
            let currentAccounts = getAccounts();
            currentAccounts = currentAccounts.filter(acc => acc.name !== name);
            saveAccounts(currentAccounts);
            displayAccounts();
        }
    };

    const login = (name) => {
        accounts = getAccounts();
        const account = accounts.find(acc => acc.name === name);
        if (account) {
            currentPlayer = account;
            playerBalance = account.balance;
            gameHistory = account.history || [];
            roundCounter = gameHistory.length;
        }
        playerNameElem.textContent = currentPlayer.name;
        updateBalance(playerBalance);
        renderHistoryTable();
        loginScreen.style.display = 'none';
        gameContainer.style.display = 'grid';
    };

    const playAsGuest = () => {
        currentPlayer = { name: 'Khách', balance: 1000, history: [] }; // Guest session object
        playerBalance = 1000;
        gameHistory = [];
        roundCounter = 0;
        playerNameElem.textContent = "Chế độ Khách";
        updateBalance(playerBalance);
        renderHistoryTable();
        loginScreen.style.display = 'none';
        gameContainer.style.display = 'grid';
    };

    const logout = () => {
        if (currentPlayer && currentPlayer.name !== 'Khách') {
             saveCurrentPlayerState();
        }
        currentPlayer = null;
        gameContainer.style.display = 'none';
        loginScreen.style.display = 'block';
        resetBoard(true); // Reset board silently
        displayAccounts(); // Refresh account list
    };

    const saveCurrentPlayerState = () => {
        if (!currentPlayer || currentPlayer.name === 'Khách') return;
        const accountIndex = accounts.findIndex(acc => acc.name === currentPlayer.name);
        if (accountIndex !== -1) {
            accounts[accountIndex].balance = playerBalance;
            accounts[accountIndex].history = gameHistory;
            saveAccounts(accounts);
        }
    };
    
    // --- GAME LOGIC FUNCTIONS (with modifications) ---
    const updateBalance = (amount) => {
        playerBalance = amount;
        balanceElem.textContent = `Điểm: ${playerBalance}`;
    };

    const checkWinnings = (dice, total) => {
        // ... (rest of checkWinnings is the same as before)
        const isTriple = dice[0] === dice[1] && dice[1] === dice[2];
        let totalWinnings = 0;
        const totalBetAmount = Object.values(bets).reduce((sum, amount) => sum + amount, 0);

        for (const betType in bets) {
            const betAmount = bets[betType];
            let won = false;
            if (betType === 'tai' && total >= 11 && total <= 17 && !isTriple) won = true;
            else if (betType === 'xiu' && total >= 4 && total <= 10 && !isTriple) won = true;
            
            const betElem = document.querySelector(`[data-bet-type='${betType}']`);
            if (won) {
                totalWinnings += betAmount + (betAmount * PAYOUTS[betType]);
                betElem.classList.add('win');
            } else {
                betElem.classList.add('lose');
            }
        }

        const newBalance = playerBalance + totalWinnings;
        updateBalance(newBalance); // Update UI
        const netChange = totalWinnings - totalBetAmount;
        
        let resultString = `Tổng: ${total}. `;
        if (netChange > 0) resultString += `Thắng ${netChange} điểm!`;
        else if (netChange < 0) resultString += `Thua ${Math.abs(netChange)} điểm.`;
        else resultString += "Hòa vốn.";
        
        resultMessageElem.textContent = resultString;
        updateHistory(dice, total, isTriple, netChange);
        saveCurrentPlayerState(); // Save after every round
        startNewRoundTimer(5);
    };
    
    const updateHistory = (dice, total, isTriple, netChange) => {
        roundCounter++;
        const historyEntry = {
            round: roundCounter,
            dice: dice.join('-'),
            total: total,
            result: isTriple ? "Bộ Ba" : (total > 10 ? "Tài" : "Xỉu"),
            change: netChange,
        };
        gameHistory.unshift(historyEntry);
        if (gameHistory.length > 15) gameHistory.pop();
        renderHistoryTable();
    };

    const renderHistoryTable = () => {
        historyBody.innerHTML = '';
        gameHistory.forEach(entry => {
            const row = document.createElement('tr');
            let changeClass = entry.change > 0 ? 'win' : (entry.change < 0 ? 'loss' : '');
            row.innerHTML = `
                <td>#${entry.round}</td>
                <td class="dice-result">${entry.dice}</td>
                <td>${entry.total}</td>
                <td><b>${entry.result}</b></td>
                <td class="${changeClass}">${entry.change > 0 ? '+' : ''}${entry.change}</td>
            `;
            historyBody.appendChild(row);
        });
    };

    const resetBoard = (isSilent = false) => {
        clearInterval(countdownIntervalId);
        countdownIntervalId = null;
        bets = {};
        betOptions.forEach(opt => {
            opt.classList.remove('selected', 'win', 'lose');
            const display = opt.querySelector('.bet-placed-display');
            if (display) display.remove();
        });
        diceElems.forEach(d => d.textContent = '?');
        resultMessageElem.textContent = "Hãy đặt cược cho ván mới!";
        countdownTimerElem.textContent = '';
        toggleControls(false);

        if (!isSilent && playerBalance <= 0) {
            alert("Bạn đã hết điểm! Tặng bạn 500 điểm để chơi tiếp.");
            updateBalance(500);
            saveCurrentPlayerState();
        }
    };
    
    // --- Initial Setup and Event Listeners ---
    displayAccounts(); // Initial call
    
    createAccountForm.addEventListener('submit', (e) => {
        e.preventDefault();
        createAccount(usernameInput.value.trim());
        usernameInput.value = '';
    });

    playGuestBtn.addEventListener('click', playAsGuest);
    logoutBtn.addEventListener('click', logout);
    
    // Attach other game listeners (same as before)
    const rollDice = () => { /* ... same as before ... */
        if (Object.keys(bets).length === 0) { alert("Vui lòng đặt cược!"); return; }
        toggleControls(true); resultMessageElem.textContent = "Đang lắc...";
        let rollCount = 0;
        const rollInterval = setInterval(() => {
            diceElems.forEach(d => d.textContent = Math.floor(Math.random() * 6) + 1);
            if (++rollCount > 20) { clearInterval(rollInterval); finalizeRoll(); }
        }, 100);
    };
    const finalizeRoll = () => { /* ... same as before ... */
        const dice = [1, 2, 3].map(() => Math.floor(Math.random() * 6) + 1);
        const total = dice.reduce((a, b) => a + b);
        dice.forEach((val, i) => diceElems[i].textContent = val);
        checkWinnings(dice, total);
    };
    const placeBet = (betType, amount) => { /* ... same as before ... */
        if (isRoundActive) return;
        if (amount <= 0) { alert("Mức cược không hợp lệ!"); return; }
        if (amount > playerBalance) { alert("Không đủ điểm!"); return; }
        updateBalance(playerBalance - amount);
        bets[betType] = (bets[betType] || 0) + amount;
        const betOptionElem = document.querySelector(`[data-bet-type='${betType}']`);
        betOptionElem.classList.add('selected');
        let display = betOptionElem.querySelector('.bet-placed-display');
        if (!display) {
            display = document.createElement('div');
            display.className = 'bet-placed-display';
            betOptionElem.appendChild(display);
        }
        display.textContent = bets[betType];
    };
    const startNewRoundTimer = (seconds) => { /* ... same as before ... */
        let remaining = seconds;
        countdownTimerElem.textContent = `Ván mới sau: ${remaining}s`;
        countdownIntervalId = setInterval(() => {
            remaining--;
            countdownTimerElem.textContent = `Ván mới sau: ${remaining}s`;
            if (remaining <= 0) resetBoard();
        }, 1000);
    };
    const toggleControls = (active) => { /* ... same as before ... */
        isRoundActive = active;
        rollBtn.disabled = active;
        resetBtn.disabled = !active;
        betAmountInput.disabled = active;
        betOptions.forEach(b => b.disabled = active);
    };

    betOptions.forEach(option => {
        option.addEventListener('click', () => {
            const betType = option.dataset.betType;
            const amount = parseInt(betAmountInput.value);
            placeBet(betType, amount);
        });
    });
    rollBtn.addEventListener('click', rollDice);
    resetBtn.addEventListener('click', () => resetBoard(false));
});
</script>

</body>
</html>
